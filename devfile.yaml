metadata:
  name: java-openliberty
projects:
  - name: user-app
    source:
      location: 'https://github.com/ajm01/fullODOTestApp.git'
      type: git
      branch: master
components:
  - id: redhat/java/latest
    memoryLimit: 1512Mi
    type: chePlugin
  - mountSources: true
    endpoints:
      - name: 9080/tcp
        port: 9080
#    command:
#      - tail
#    args:
#      - '-f'
#      - /dev/null
    memoryLimit: 768Mi
    type: dockerimage
    volumes:
      - name: m2
        containerPath: /home/user/.m2
    alias: appsodyrun
    image: 'kabanero/ubi8-maven:0.3.1'
    env:
      - value: TEST2
        name: MODE2
      - value: myval2
        name: myprop2
apiVersion: 1.0.0
commands:
  - name: devInit
    actions:
      - workdir: /projects/user-app
        type: exec
        command: echo "HELLO WORLD FROM DEVINIT" 
                 && groupadd --gid 1000 java_group 
                 && useradd --uid 1000 --gid java_group --shell /bin/bash --create-home java_user 
                 && mkdir -p /opt/ol 
                 && chown -R java_user:java_group /opt 
                 && mvn -B -N io.takari:maven:wrapper -Dmaven=$(mvn help:evaluate -Dexpression=maven.version -q -DforceStdout)
                 && mvn -B liberty:install-server dependency:go-offline -DruntimeInstallDirectory=/opt/ol -DskipTests=true
        component: appsodyrun
  - name: devBuild
    actions:
      - workdir: /projects/user-app
        type: exec
        command: mvn -B -DappsDirectory=apps -DinstallDirectory=/opt/ol/wlp liberty:create pre-integration-test liberty:install-feature 
        component: appsodyrun
  - name: devRun
    actions:
      - workdir: /projects/user-app
        type: exec
        command: mvn -B -DappsDirectory=apps -DinstallDirectory=/opt/ol/wlp liberty:start liberty:deploy
        component: appsodyrun
    attributes:
        restart: "false"

